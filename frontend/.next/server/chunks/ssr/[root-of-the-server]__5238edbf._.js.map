{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/internshala-assignments/Real-Time-Chat/frontend/app/chat/page.tsx"],"sourcesContent":["// app/chat/page.tsx\r\n\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { io, Socket } from \"socket.io-client\";\r\n\r\ninterface Message {\r\n  _id?: string;\r\n  sender: string;\r\n  receiver: string;\r\n  content: string;\r\n  timestamp: Date;\r\n  isOwnMessage?: boolean;\r\n}\r\n\r\ninterface User {\r\n  _id: string;\r\n  username: string;\r\n  isActive: boolean;\r\n  lastActiveText: string;\r\n  messages: Message[];\r\n}\r\n\r\nexport default function Chat() {\r\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [newMessage, setNewMessage] = useState(\"\");\r\n  const [socket, setSocket] = useState<Socket | null>(null);\r\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const router = useRouter();\r\n\r\n  // Scroll to bottom of messages\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  };\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n\r\n  useEffect(() => {\r\n    // Get selected user from session storage\r\n    const userData = sessionStorage.getItem(\"selectedUser\");\r\n    if (userData) {\r\n      setSelectedUser(JSON.parse(userData));\r\n    } else {\r\n      router.push(\"/dashboard\");\r\n    }\r\n\r\n    const currentuser = sessionStorage.getItem(\"user\");\r\n    setCurrentUser(JSON.parse(currentuser || \"{}\"));\r\n\r\n    // Initialize socket connection\r\n    const newSocket = io(\"http://localhost:5000\", {\r\n      transports: [\"websocket\"],\r\n      auth: {\r\n        token: localStorage.getItem(\"token\"),\r\n      },\r\n    });\r\n    setSocket(newSocket);\r\n\r\n    // Listen for incoming messages\r\n    newSocket.on(\"receiveMessage\", (data: Message) => {\r\n      setMessages((prevMessages) => [...prevMessages, data]);\r\n    });\r\n\r\n    // Clean up on unmount\r\n    return () => {\r\n      newSocket.disconnect();\r\n    };\r\n  }, [router]);\r\n\r\n  useEffect(() => {\r\n    if (socket && currentUser && selectedUser) {\r\n      // Join room for these two users\r\n      const roomId = [currentUser._id, selectedUser._id].sort().join(\"-\");\r\n      socket.emit(\"joinRoom\", roomId);\r\n\r\n      // Load previous messages\r\n      const fetchMessages = async () => {\r\n        try {\r\n          const response = await fetch(\r\n            `http://localhost:5000/api/messages/${currentUser._id}/${selectedUser._id}`,\r\n            {\r\n              headers: {\r\n                Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\r\n              },\r\n            }\r\n          );\r\n          if (response.ok) {\r\n            const data = await response.json();\r\n            setMessages(data);\r\n          }\r\n        } catch (error) {\r\n          console.error(\"Failed to fetch messages:\", error);\r\n        }\r\n      };\r\n\r\n      fetchMessages();\r\n    }\r\n\r\n    return () => {\r\n      if (socket) {\r\n        socket.off(\"receiveMessage\");\r\n      }\r\n    };\r\n  }, [socket, currentUser, selectedUser]);\r\n\r\n  const handleSendMessage = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (newMessage.trim() === \"\" || !socket || !currentUser || !selectedUser)\r\n      return;\r\n\r\n    const messageData: Message = {\r\n      sender: currentUser._id,\r\n      receiver: selectedUser._id,\r\n      content: newMessage.trim(),\r\n      timestamp: new Date(),\r\n      isOwnMessage: true,\r\n    };\r\n\r\n    // Get room ID\r\n    const roomId = [currentUser._id, selectedUser._id].sort().join(\"-\");\r\n\r\n    // Emit message to server with correct structure\r\n    socket.emit(\"sendMessage\", {\r\n      roomId,\r\n      message: messageData,\r\n    });\r\n\r\n    // Optimistically add to UI\r\n    setMessages((prevMessages) => [...prevMessages, messageData]);\r\n    setNewMessage(\"\");\r\n  };\r\n\r\n  const formatTime = (date: Date) => {\r\n    return new Date(date).toLocaleTimeString([], {\r\n      hour: \"2-digit\",\r\n      minute: \"2-digit\",\r\n    });\r\n  };\r\n\r\n  if (!selectedUser || !currentUser) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-100 flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex h-screen bg-gray-100\">\r\n      {/* Sidebar */}\r\n      <div className=\"w-1/4 bg-white border-r border-gray-200 flex flex-col\">\r\n        <div className=\"p-4 border-b border-gray-200 bg-indigo-600 text-white\">\r\n          <h1 className=\"text-xl font-bold\">ChatApp</h1>\r\n          <button\r\n            onClick={() => router.push(\"/dashboard\")}\r\n            className=\"mt-2 text-sm text-indigo-100 hover:text-white\"\r\n          >\r\n            ‚Üê Back to Dashboard\r\n          </button>\r\n        </div>\r\n        <div className=\"p-4 border-b border-gray-200 flex items-center\">\r\n          <div className=\"flex-shrink-0 relative\">\r\n            <div className=\"h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-800 font-semibold\">\r\n              {currentUser.username.charAt(0).toUpperCase()}\r\n            </div>\r\n          </div>\r\n          <div className=\"ml-3\">\r\n            <p className=\"text-sm font-medium text-gray-900\">\r\n              {currentUser.username}\r\n            </p>\r\n            <p className=\"text-xs text-gray-500\">You</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Chat Area */}\r\n      <div className=\"flex-1 flex flex-col\">\r\n        {/* Chat Header */}\r\n        <div className=\"bg-white px-6 py-4 border-b border-gray-200 flex items-center\">\r\n          <div className=\"flex-shrink-0 relative\">\r\n            <div className=\"h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-800 font-semibold\">\r\n              {selectedUser.username.charAt(0).toUpperCase()}\r\n            </div>\r\n            <div\r\n              className={`absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-white ${\r\n                selectedUser.isActive ? \"bg-green-500\" : \"bg-gray-400\"\r\n              }`}\r\n            ></div>\r\n          </div>\r\n          <div className=\"ml-4\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900\">\r\n              {selectedUser.username}\r\n            </h2>\r\n            <p className=\"text-sm text-gray-500\">\r\n              {selectedUser.isActive ? \"Online\" : selectedUser.lastActiveText}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Chat Messages */}\r\n        <div\r\n          className=\"flex-1 overflow-y-auto p-6 bg-[#e5ddd5] bg-opacity-60\"\r\n          style={{\r\n            backgroundImage: `url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")`,\r\n          }}\r\n        >\r\n          <div className=\"space-y-4\">\r\n            {messages.map((message, index) => (\r\n              <div\r\n                key={index}\r\n                className={`flex ${\r\n                  message.sender === currentUser._id || message.isOwnMessage\r\n                    ? \"justify-end\"\r\n                    : \"justify-start\"\r\n                }`}\r\n              >\r\n                <div\r\n                  className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${\r\n                    message.sender === currentUser._id || message.isOwnMessage\r\n                      ? \"bg-indigo-500 text-white\"\r\n                      : \"bg-white text-gray-800\"\r\n                  }`}\r\n                >\r\n                  <p>{message.content}</p>\r\n                  <p\r\n                    className={`text-xs mt-1 ${\r\n                      message.sender === currentUser._id || message.isOwnMessage\r\n                        ? \"text-indigo-100\"\r\n                        : \"text-gray-500\"\r\n                    }`}\r\n                  >\r\n                    {formatTime(message.timestamp)}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Message Input */}\r\n        <div className=\"bg-gray-100 px-6 py-4 border-t border-gray-200\">\r\n          <form onSubmit={handleSendMessage} className=\"flex space-x-4\">\r\n            <input\r\n              type=\"text\"\r\n              value={newMessage}\r\n              onChange={(e) => setNewMessage(e.target.value)}\r\n              placeholder=\"Type a message...\"\r\n              className=\"flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent\"\r\n            />\r\n            <button\r\n              type=\"submit\"\r\n              disabled={newMessage.trim() === \"\"}\r\n              className=\"bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white px-4 py-2 rounded-full\"\r\n            >\r\n              <svg\r\n                xmlns=\"http://www.w3.org/2000/svg\"\r\n                className=\"h-6 w-6\"\r\n                fill=\"none\"\r\n                viewBox=\"0 0 24 24\"\r\n                stroke=\"currentColor\"\r\n              >\r\n                <path\r\n                  strokeLinecap=\"round\"\r\n                  strokeLinejoin=\"round\"\r\n                  strokeWidth={2}\r\n                  d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\"\r\n                />\r\n              </svg>\r\n            </button>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}